{% extends "base.html" %}

{% block title %}Nuovo Pasto - Piattaforma{% endblock %}

{% block extra_css %}
<style>
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }

    .step::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: 0;
    }

    .step:first-child::before {
        left: 50%;
    }

    .step:last-child::before {
        right: 50%;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        position: relative;
        z-index: 1;
        margin-bottom: 0.5rem;
    }

    .step.active .step-number {
        background: #667eea;
        color: white;
    }

    .step.completed .step-number {
        background: #10b981;
        color: white;
    }

    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
    }

    .alternative-card {
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .alternative-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .alternative-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .alternative-card .badge {
        font-size: 0.75rem;
    }

    .manual-input-toggle {
        text-align: center;
        margin: 2rem 0;
        padding-top: 2rem;
        border-top: 2px dashed #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Nuovo Pasto</h4>
            </div>
            <div class="card-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1-indicator">
                        <div class="step-number">1</div>
                        <div class="small">Tipo & Data</div>
                    </div>
                    <div class="step" id="step2-indicator">
                        <div class="step-number">2</div>
                        <div class="small">Selezione</div>
                    </div>
                    <div class="step" id="step3-indicator">
                        <div class="step-number">3</div>
                        <div class="small">Conferma</div>
                    </div>
                </div>

                <form method="POST" id="pastoForm">
                    <!-- Step 1: Tipo Pasto e Data -->
                    <div class="step-content active" id="step1">
                        <h5 class="mb-4">Quando hai mangiato?</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data *</label>
                                <input type="date" name="data" id="dataInput" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo Pasto *</label>
                                <select name="tipo_pasto" id="tipoPasto" class="form-control" required>
                                    <option value="">Seleziona...</option>
                                    <option value="Colazione">Colazione</option>
                                    <option value="Spuntino mattina">Spuntino mattina</option>
                                    <option value="Pranzo">Pranzo</option>
                                    <option value="Spuntino pomeriggio">Spuntino pomeriggio</option>
                                    <option value="Cena">Cena</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('fitness.pasti') }}" class="btn btn-secondary">Annulla</a>
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">Avanti <i class="bi bi-arrow-right"></i></button>
                        </div>
                    </div>

                    <!-- Step 2: Selezione Alternative -->
                    <div class="step-content" id="step2">
                        <h5 class="mb-4">Cosa hai mangiato?</h5>
                        <div id="alternativesContainer"></div>

                        <div class="manual-input-toggle">
                            <p class="text-muted mb-3">Non trovi il tuo pasto?</p>
                            <button type="button" class="btn btn-outline-secondary" onclick="showManualInput()">
                                <i class="bi bi-pencil"></i> Inserisci manualmente
                            </button>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary" onclick="previousStep(1)"><i class="bi bi-arrow-left"></i> Indietro</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)" id="btnStep2Next">Avanti <i class="bi bi-arrow-right"></i></button>
                        </div>
                    </div>

                    <!-- Step 3: Conferma -->
                    <div class="step-content" id="step3">
                        <h5 class="mb-4">Riepilogo</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Data:</strong>
                                        <p id="summaryData">-</p>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Tipo Pasto:</strong>
                                        <p id="summaryTipo">-</p>
                                    </div>
                                    <div class="col-md-12 mt-3">
                                        <strong>Descrizione:</strong>
                                        <p id="summaryDescrizione">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="descrizione" id="descrizioneHidden">

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary" onclick="previousStep(2)"><i class="bi bi-arrow-left"></i> Indietro</button>
                            <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Salva Pasto</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Database pasti per tipo
const pastiDatabase = {
    'Colazione': [
        { nome: 'Alternativa 1', desc: 'Caffè e latte, clementine, 100g albume + 1 uovo, pane e burro d\'arachidi', tag: 'Allenamento' },
        { nome: 'Alternativa 2', desc: 'Caffè e latte, banana, fiocchi d\'avena, yogurt greco bianco, 20g cioccolato fondente', tag: 'Weekend' }
    ],
    'Spuntino mattina': [
        { nome: 'Alternativa 1', desc: 'Banana + yogurt greco', tag: 'Allenamento' },
        { nome: 'Alternativa 2', desc: '30g frutta secca', tag: 'Riposo' },
        { nome: 'Alternativa 3', desc: 'Barretta', tag: 'Riposo' }
    ],
    'Pranzo': [
        { nome: 'Alternativa 1', desc: '100g carote, 90g riso, 200g verdure, 200g sgombro', tag: 'Allenamento' },
        { nome: 'Alternativa 2', desc: '100g carote, 90g riso, 200g verdure, 250g lenticchie', tag: 'Allenamento' },
        { nome: 'Alternativa 3', desc: '100g carote, 90g riso, 200g verdure, 250g fagioli', tag: 'Allenamento' },
        { nome: 'Alternativa 4', desc: '100g carote, 70g riso, 200g verdure, 200g sgombro', tag: 'Riposo' },
        { nome: 'Alternativa 5', desc: '100g carote, 70g riso, 200g verdure, 250g lenticchie', tag: 'Riposo' },
        { nome: 'Alternativa 6', desc: '100g carote, 70g riso, 200g verdure, 250g fagioli', tag: 'Riposo' }
    ],
    'Spuntino pomeriggio': [
        { nome: 'Alternativa 1', desc: 'Taralli e cioccolato', tag: 'Allenamento' },
        { nome: 'Alternativa 2', desc: 'Frutta (pera abate / 2 susine / melagrana) + frutta secca', tag: 'Riposo' }
    ],
    'Cena': [
        { nome: 'Alternativa 1', desc: '100g verdura cruda (finocchio/pomodoro), 200g verdura cotta, 200g pollo', tag: 'Standard' },
        { nome: 'Alternativa 2', desc: '100g verdura cruda (finocchio/pomodoro), 200g verdura cotta, 250g ricotta', tag: 'Allenamento B' },
        { nome: 'Alternativa 3', desc: '100g verdura cruda (finocchio/pomodoro), 200g verdura cotta, 200g carpaccio di sorana', tag: 'Weekend' },
        { nome: 'Pasto libero', desc: 'PASTO LIBERO (domenica sera)', tag: 'Libero' }
    ]
};

let selectedAlternative = null;

// Imposta data odierna
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dataInput').value = today;
});

// Gestione tipo pasto selezionato
document.getElementById('tipoPasto').addEventListener('change', function() {
    const tipo = this.value;
    const container = document.getElementById('alternativesContainer');

    if (!tipo) {
        container.innerHTML = '';
        return;
    }

    const alternative = pastiDatabase[tipo] || [];
    let html = '';

    alternative.forEach((alt, index) => {
        html += `
            <div class="alternative-card" onclick="selectAlternative('${tipo}', ${index})">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-2">${alt.nome}</h6>
                        <p class="mb-0 small text-muted">${alt.desc}</p>
                    </div>
                    <span class="badge bg-info">${alt.tag}</span>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
});

function selectAlternative(tipo, index) {
    // Rimuovi selezione precedente
    document.querySelectorAll('.alternative-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Seleziona nuovo
    event.currentTarget.classList.add('selected');
    selectedAlternative = pastiDatabase[tipo][index];

    // Abilita pulsante avanti
    document.getElementById('btnStep2Next').disabled = false;
}

function showManualInput() {
    const desc = prompt('Inserisci la descrizione del pasto:');
    if (desc) {
        selectedAlternative = { nome: 'Manuale', desc: desc };
        document.getElementById('btnStep2Next').disabled = false;
    }
}

function nextStep(stepNumber) {
    // Validazione
    if (stepNumber === 2) {
        const tipoPasto = document.getElementById('tipoPasto').value;
        if (!tipoPasto) {
            alert('Seleziona un tipo di pasto');
            return;
        }
    }

    if (stepNumber === 3) {
        if (!selectedAlternative) {
            alert('Seleziona un\'alternativa o inserisci manualmente');
            return;
        }

        // Aggiorna riepilogo
        document.getElementById('summaryData').textContent = document.getElementById('dataInput').value;
        document.getElementById('summaryTipo').textContent = document.getElementById('tipoPasto').value;
        document.getElementById('summaryDescrizione').textContent = selectedAlternative.desc;
        document.getElementById('descrizioneHidden').value = selectedAlternative.desc;
    }

    // Cambia step
    document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
    document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));

    document.getElementById('step' + stepNumber).classList.add('active');
    document.getElementById('step' + stepNumber + '-indicator').classList.add('active');

    // Marca come completati gli step precedenti
    for (let i = 1; i < stepNumber; i++) {
        document.getElementById('step' + i + '-indicator').classList.add('completed');
    }
}

function previousStep(stepNumber) {
    document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
    document.querySelectorAll('.step').forEach(step => step.classList.remove('active', 'completed'));

    document.getElementById('step' + stepNumber).classList.add('active');
    document.getElementById('step' + stepNumber + '-indicator').classList.add('active');

    for (let i = 1; i < stepNumber; i++) {
        document.getElementById('step' + i + '-indicator').classList.add('completed');
    }
}
</script>
{% endblock %}
